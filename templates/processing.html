{% extends "base.html" %}

{% block title %}Processing - Football Analysis System{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-12 text-center">
            <h1 class="display-5 fw-bold mb-3">Processing Your Video</h1>
            <p class="lead mb-5">We're analyzing your football video. This may take a few minutes...</p>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <div class="text-center mb-4">
                        <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>

                    <div class="progress mb-4">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                            role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0"
                            aria-valuemax="100">0%</div>
                    </div>

                    <div class="alert alert-info" role="alert">
                        <h5 class="alert-heading"><i class="bi bi-info-circle me-2"></i>Processing Information</h5>
                        <p class="mb-0">Your video is being processed with advanced computer vision algorithms
                            including:</p>
                        <ul class="mb-0 mt-2">
                            <li>Player detection and tracking</li>
                            <li>Team color assignment</li>
                            <li>Ball tracking</li>
                            <li>Speed and distance measurements</li>
                            <li>Ball possession analysis</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-5">
        <div class="col-12 text-center">
            <p class="text-muted">Please keep this page open while processing. You'll be automatically redirected when
                complete.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Poll for progress updates
    document.addEventListener('DOMContentLoaded', function () {
        const taskId = "{{ task_id }}";
        const progressBar = document.getElementById('progress-bar');

        function updateProgress() {
            fetch(`/progress/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error:', data.error);
                        alert('Processing error: ' + data.error);
                        window.location.href = '/';
                        return;
                    }

                    // Update progress bar
                    progressBar.style.width = data.progress + '%';
                    progressBar.textContent = data.progress + '%';
                    progressBar.setAttribute('aria-valuenow', data.progress);

                    // Check if processing is complete
                    if (data.status === 'completed') {
                        // Redirect to results page
                        window.location.href = `/results/${data.output_file}`;
                    } else if (data.status === 'failed') {
                        // Show error message
                        alert('Processing failed: ' + (data.error || 'Unknown error'));
                        window.location.href = '/';
                    } else {
                        // Continue polling
                        setTimeout(updateProgress, 1000);
                    }
                })
                .catch(error => {
                    console.error('Error fetching progress:', error);
                    setTimeout(updateProgress, 1000);
                });
        }

        // Start polling for progress
        updateProgress();
    });
</script>
{% endblock %}